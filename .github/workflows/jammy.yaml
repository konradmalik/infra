name: Ubuntu Jammy test

on: [push]

jobs:
  # test:
  #   runs-on: ubuntu-latest
  #   env:
  #     FORCE_COLOR: 1
  #   steps:
  #     - uses: actions/checkout@v3
  #     - name: Put back the git branch into git (Earthly uses it for tagging)
  #       run: |
  #         branch=""
  #         if [ -n "$GITHUB_HEAD_REF" ]; then
  #           branch="$GITHUB_HEAD_REF"
  #         else
  #           branch="${GITHUB_REF##*/}"
  #         fi
  #         git checkout -b "$branch" || true
  #     - name: Download latest earthly
  #       run: "sudo /bin/sh -c 'wget https://github.com/earthly/earthly/releases/download/v0.6.19/earthly-linux-amd64 -O /usr/local/bin/earthly && chmod +x /usr/local/bin/earthly'"
  #     - name: Earthly version
  #       run: earthly --version
  #     - name: Run for archlinux
  #       working-directory: ./environments/dev
  #       run: earthly --ci --push +ansible --BASE=+arch
  vagrant-up:
    runs-on: macos-10.15
    env:
      VAGRANT_BOX: ubuntu/jammy64
    steps:
      - uses: actions/checkout@v2

      - name: Cache Vagrant boxes
        uses: actions/cache@v2
        with:
          path: ~/.vagrant.d/boxes
          key: ${{ runner.os }}-vagrant-${{ hashFiles('Vagrantfile') }}-${{ env.VAGRANT_BOX }}
          restore-keys: |
            ${{ runner.os }}-vagrant-

      - name: Show Vagrant version
        run: vagrant --version
        working-directory: ./environments/dev

      - name: Update box
        run: vagrant box update
        working-directory: ./environments/dev

      - name: Clean old boxes
        run: vagrant box prune --force
        working-directory: ./environments/dev

      - name: Run vagrant up
        run: vagrant up
        working-directory: ./environments/dev

      - name: ssh into box after boot
        run: vagrant ssh -c "echo 'hello world!'"
        working-directory: ./environments/dev
